//******************************************************************************
// <copyright file="license.md" company="RawCMS project  (https://github.com/arduosoft/RawCMS)">
// Copyright (c) 2019 RawCMS project  (https://github.com/arduosoft/RawCMS)
// RawCMS project is released under GPL3 terms, see LICENSE file on repository root at  https://github.com/arduosoft/RawCMS .
// </copyright>
// <author>Daniele Fontani, Emanuele Bucarelli, Francesco Min?</author>
// <autogenerated>true</autogenerated>
//******************************************************************************
using Newtonsoft.Json;
using RawCMS.Client.BLL.Core;
using RawCMS.Client.BLL.Helper;
using RawCMS.Client.BLL.Parser;
using RestSharp;
using System;
using Xunit;

namespace RawCMS.Test
{
    public class CRUDTest
    {
        private string baseUrl = "http://localhost:49439";
        private string clientId = "raw.client";
        private string clientSecret = "raw.secret";
        private string username = "bob";
        private string password = "XYZ";

        [Fact]
        public void CRUD()
        {
        }

        /* tests */

        [Fact]
        public void GetTokenFromFileTest()
        {
            LoginOptions lo = new LoginOptions
            {
                ClientId = clientId,
                ClientSecret = clientSecret,
                Password = password,
                ServerUrl = baseUrl,
                Username = username,
            };
            string token = TokenHelper.getToken(lo);

            Assert.False(string.IsNullOrEmpty(token));

            string mydocpath = Environment.GetFolderPath(Environment.SpecialFolder.MyDocuments);
            string fileconfigname = ClientConfig.GetValue<string>("ConfigFile");
            fileconfigname = string.Format(fileconfigname, username);
            string filePath = System.IO.Path.Combine(mydocpath, fileconfigname);

            ConfigFile cf = new ConfigFile
            {
                Token = token,
                CreatedTime = DateTime.Now.ToShortDateString(),
                ServerUrl = baseUrl,
                User = username
            };

            TokenHelper.SaveTokenToFile(filePath, cf);
            string tokenfile = TokenHelper.getTokenFromFile();
            Assert.True(tokenfile.Equals(token));
        }

        [Fact]
        public void TestGetToken()
        {
            LoginOptions lo = new LoginOptions
            {
                ClientId = clientId,
                ClientSecret = clientSecret,
                Password = password,
                ServerUrl = baseUrl,
                Username = username,
            };
            // get token
            string token = TokenHelper.getToken(lo);
            Assert.True(!string.IsNullOrEmpty(token));

            // create new user
            bool user = createUser();
            Assert.True(user);
        }

        private bool createUser()
        {
            LoginOptions lo = new LoginOptions
            {
                ClientId = clientId,
                ClientSecret = clientSecret,
                Password = password,
                ServerUrl = baseUrl,
                Username = username,
            };
            string token = TokenHelper.getToken(lo);
            //create RestSharp client and POST request object
            string collection = "_users";

            string url = $"{baseUrl}/api/CRUD/{collection}";
            RestClient client = new RestClient(url);
            RestRequest request = new RestRequest(Method.POST)
            {
                //request headers
                RequestFormat = DataFormat.Json
            };
            request.AddHeader("Content-Type", "application/json");

            //object containing input parameter data for DoStuff() API method
            var apiInput = new
            {
                UserName = "Matt",
                NormalizedUserName = "Mattius",
                Email = "info@matt.com",
                PasswordHash = "asd",
            };

            //add parameters and token to request
            request.Parameters.Clear();
            request.AddParameter("application/json", JsonConvert.SerializeObject(apiInput), ParameterType.RequestBody);
            request.AddParameter("Authorization", "Bearer " + token, ParameterType.HttpHeader);

            //make the API request and get a response
            IRestResponse response = client.Execute(request);

            //ApiResponse is a class to model the data we want from the API response
            if (!response.IsSuccessful)
            {
                return false;
            }

            return true;
        }

        private bool deleteUser()
        {
            return false;
        }

        private bool updateUser()
        {
            return false;
        }

        private bool getUser()
        {
            return false;
        }
    }
}